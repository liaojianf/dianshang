```
项目描述：电商系统是由五个子项目组成的项目，分别是后台管理系统，商品交易系统，用户登陆系统，日志记录系统，商品全文搜索系统 项目框架技术：spring+springmvc+mybatis+cxf+layui+solr+activeMQ+webservice 主要职责 
1.后台管理系统，使用layui搭建框架，多文件上传 
2.商品交易系统，包括购物车，迷你购物，订单物流，同时用到cookie和session保存用户信息和购物车信息，cookie主要用来用户未登陆时显示购物车缓存数据和用户登陆的昵称，还有商品超卖问题通过加锁(for update)来解决 
3.登陆系统，用途是在交易系统进行登陆时，通过实现AbstractRoutingDataSource接口来切换数据源，交易系统调用webservice暴露出来的接口，进行判断是否有该用户，决定是否通过登陆 
4.日志记录系统，在用户登陆完成后通过HttpGet请求调用日志系统的url接口传递参数过去，同时把日志信息保存到数据库中，然后日志系统中配置好了activeMQ的监听器，登陆后会在交易系统中通过jmsTemplate模板引擎发送消息过去保存到数据库中 
5.商品全文搜索系统，用到solr搜索应用服务器，先从数据库中查询到数据放到solr上，在交易系统中通过HttpGet请求发送关键字到搜索系统中，调用solr的httpSolrServer.query获取到数据返回到交易系统 
难点：
1 登陆后需要同步并且排查cookie中的数据到数据库中，然后清空cookie同步session 
2.交易系统调用用户系统通过cxf+webservice暴露出来的接口时，一直报各种异常，最后排查了很久才发现是缺少了jar包 
3 购物时选择商品的款式和版本，还有就是通过加锁解决商品超卖的问题 
4 商品列表页面可以通过选择商品的属性来筛选商品
```

login.jsp登陆页面  

登陆后去到LoginController类标注login.do请求的方法

#### login方法

##### 1 远程调用user系统登陆接口

```jsp
		<div class="box_01_both">
						<div class="box_01_both_1">数据源1：<input type="radio" name="dataSource_type" value="1"/></div>
						<div class="box_01_both_2">数据源2：<input type="radio" name="dataSource_type" value="2"/></div>
					</div>
```

```java
//判断前端穿过来的数据源	
if (dataSource_type.equals("1")){
    //远程调用user系统通过webservice暴露出来的接口
				 loginJson = loginServerInfs.login(user);
			}else if(dataSource_type.equals("2")){
				 loginJson = loginServerInfs.login2(user);
			}
//通过util包的工具类把json数据转换成T_MALL_USER_ACCOUNT.class
users = MyJsonUtil.json_to_object(loginJson,T_MALL_USER_ACCOUNT.class);
```

配置跟user系统一样的接口，用来接受user系统暴露出来的接口以及实现类

```java
@WebService
public interface LoginServerInfs {
    String login(T_MALL_USER_ACCOUNT user);
    String login2(T_MALL_USER_ACCOUNT user);
    String register(T_MALL_USER_ACCOUNT user);;

}
```

```java
//继承了FactoryBean的类不会直接调用FactoryBean的构造器去创建bean 而是通过getObject将结果返回给spring容器
//好处：让程序员参与到spring容器的创建过程，一般的bean，项目一启动就自动加载到ioc容器中，而这个需要调用getObject方法才生成bean
//继承抽象类  实现回调函数
public class MyWsFactoryBeans<T> implements FactoryBean<T> {
    private String url;
    private Class<T> t;
    public static <T> T getMyWs(String url, Class<T> t){//List<int> list
        System.out.println("来咯来咯...");
        JaxWsProxyFactoryBean jwfb = new JaxWsProxyFactoryBean();
        jwfb.setAddress(url);
        jwfb.setServiceClass(t);
        T create = (T)jwfb.create();
        return create;
    }
        //再spring容器启动时，如果有类继承了FactoryBean，那就会自动调用getObject()方法
    //这个bean是什么
    @Override
    public T getObject(){
        return getMyWs(url,this.t);
    }
```

配置MyWsFactoryBeans类的远程接口地址以及要获取哪个实现类的接口

```xml
<bean id="loginServerInfs" class="com.ljf.util.MyWsFactoryBeans">
		<property name="url" value="${login_url}"></property>
		<property name="t" value="com.ljf.server.LoginServerInfs"></property>
</bean>
```

###### 在user系统内的配置

配置CXF框架拦截器

```xml
	<servlet>
		<servlet-name>cxf</servlet-name>
		<servlet-class>org.apache.cxf.transport.servlet.CXFServlet</servlet-class>
	</servlet>
	<servlet-mapping>
		<servlet-name>cxf</servlet-name>
		<url-pattern>/*</url-pattern>
	</servlet-mapping>
```

Server接口与实现

```java
	@Path("login")
	@GET
	@Consumes("application/x-www-form-urlencoded")
	@Produces("application/json")
	public String login(@BeanParam T_MALL_USER_ACCOUNT user){
		MyRoutingDataSource.setKey("1");
		T_MALL_USER_ACCOUNT select_user = loginServiceInf.login(user);
		Gson gson = new Gson();
		return gson.toJson(select_user);
	}
	@Path("login2")
	@GET
	@Consumes("application/x-www-form-urlencoded")
	@Produces("application/json")
	public String login2(@BeanParam T_MALL_USER_ACCOUNT user){
		MyRoutingDataSource.setKey("2");
		T_MALL_USER_ACCOUNT select_user = loginServiceInf.login2(user);
		Gson gson = new Gson();
		return gson.toJson(select_user);
	}
```

接口的暴露

```xml
<!--这些只能在soapui或者sale系统接口调用时使用-->
	<jaxws:endpoint address="/login"
		implementorClass="com.ljf.server.LoginServerInf">
		<jaxws:implementor>
			<bean class="com.ljf.server.Imp.LoginServerImp"></bean>
		</jaxws:implementor>
	</jaxws:endpoint>
    <jaxws:endpoint address="/address"
                    implementorClass="com.ljf.server.AddressServerInf">
        <jaxws:implementor>
            <bean class="com.ljf.server.Imp.AddressServerImp"></bean>
        </jaxws:implementor>
    </jaxws:endpoint>
<!--rest风格的可以再浏览器访问-->
	<jaxrs:server address="/loginRest">
		<jaxrs:serviceBeans>
			<bean class="com.ljf.server.Imp.LoginServerImp"></bean>
		</jaxrs:serviceBeans>
	</jaxrs:server>
```

配置完项目启动界面

![1587219625229](C:\Users\ljf\AppData\Roaming\Typora\typora-user-images\1587219625229.png)



##### 2 添加数据到log系统数据库

这个不需要接口的暴露，直接启动log系统，调用url地址就能获取到log系统返回的数据

添加数据到日志框架数据库

```properties
log_url=http://localhost:8086/log/index.do?message
```

```java
MyHttpGetUtil.doGet(MyPropertyUtil.getProperty("ws.properties", "log_url") + "=" + users.getYh_mch());
```

  index.do请求的方法

```java
@ResponseBody
    @RequestMapping("index")
    public String log(String message){
        System.out.println(message);
        Date dates = new Date();
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat();
        String format = simpleDateFormat.format(dates.getTime());
        Map<String,Object> map = new HashMap<String, Object>();
        map.put("message",message);
        map.put("date",format);
        indexServiceImp.log(map);
        return message;
    }
```

远程调用log系统url接口

```java
public class MyHttpGetUtil {

	public static String doGet(String url) throws Exception {

		// 创建Httpclient对象
		CloseableHttpClient httpclient = HttpClients.createDefault();
		// 创建http GET请求
		HttpGet httpGet = new HttpGet(url);
		CloseableHttpResponse response = null;
		try {
			// 执行请求
			response = httpclient.execute(httpGet);
			// 判断返回状态是否为200
			if (response.getStatusLine().getStatusCode() == 200) {
				return EntityUtils.toString(response.getEntity(), "UTF-8");
			}
		} finally {
			if (response != null) {
				response.close();
			}
			httpclient.close();
		}
		return null;
	}
```



##### 发送消息到MQ

```java
	@Autowired
	JmsTemplate jmsTemplate;
	@Autowired
	ActiveMQTopic topicDestination;
	@Autowired
	ActiveMQQueue queueDestination;	
//要发送mq消息
final String str = "ID:"+user.getId()+" 用户名:"+user.getYh_mch()+"登陆了";
	jmsTemplate.send(queueDestination, new MessageCreator() {
	@Override
	public Message createMessage(Session session) throws JMSException {
			return (Message) session.createTextMessage(str);
			}
		});
```

sale系统中有关mq的配置

```xml
<!-- jsm消息工厂 -->
	<bean id="targetConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
		<property name="brokerURL" value="tcp://localhost:61616" />
	</bean>
	<bean id="connectionFactory"
		  class="org.springframework.jms.connection.SingleConnectionFactory">
		<!--产生JMS Connection的ConnectionFactory -->
		<property name="targetConnectionFactory" ref="targetConnectionFactory" />
	</bean>
	<!-- 执行消息任务的模板 -->
	<bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory" ref="connectionFactory" />
	</bean>
	<bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="queue" />
	</bean>
	<bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic">
		<constructor-arg value="topic" />
	</bean>
```

sale系统发送完消息log系统进行接受

把接受到的消息写入数据库中

```java
    @ResponseBody
    @RequestMapping("index")
    public String log(String message){
        System.out.println(message);
        Date dates = new Date();
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat();
        String format = simpleDateFormat.format(dates.getTime());
        Map<String,Object> map = new HashMap<String, Object>();
        map.put("message",message);
        map.put("date",format);
        indexServiceImp.log(map);
        return message;
    }
```

log系统中有关mq的配置

```xml
<bean id="connectionFactory"
		  class="org.springframework.jms.connection.SingleConnectionFactory">
		<!--产生JMS Connection的ConnectionFactory -->
		<property name="targetConnectionFactory" ref="targetConnectionFactory" />
	</bean>
	<!-- 两种模式的消息 -->
	<bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="queue" />
	</bean>
	<bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic">
		<constructor-arg value="topic" />
	</bean>
<!-- 自定义监听类 -->
	<bean id="myMessageListener" class="com.ljf.listener.MyMessageListener"/>
	<!-- 队列消息监听容器 -->
	<bean class="org.springframework.jms.listener.DefaultMessageListenerContainer">
		<property name="connectionFactory" ref="connectionFactory" />
		<property name="destination" ref="queueDestination" />
        <!-- 指定自定义监听类 -->
		<property name="messageListener" ref="myMessageListener" />
	</bean>
	<!--订阅模式监听容器-->
	<bean class="org.springframework.jms.listener.DefaultMessageListenerContainer">
		<property name="connectionFactory" ref="connectionFactory" />
		<property name="destination" ref="topicDestination" />
        <!-- 指定自定义监听类 -->
		<property name="messageListener" ref="myMessageListener" />
	</bean>
```

把用户信息放入到session中

```java
session.setAttribute("user",users);
// 在客户端存储用户个性化信息，方便用户下次再访问网站时使用   转码
Cookie cookie = new Cookie("yh_mch", URLEncoder.encode(user.getYh_mch(),"utf-8"));
	cookie.setMaxAge(60*60*24);
response.addCookie(cookie);
```

合并购物车

```java
combine_cart(list_cart_cookie,users,response,session);
```

```java
public void combine_cart(@CookieValue(value = "list_cart_cookie",required = false) String list_cart_cookie, T_MALL_USER_ACCOUNT user,HttpServletResponse response, HttpSession session){
		List<T_MALL_SHOPPINGCAR> shoppingcars = new ArrayList<T_MALL_SHOPPINGCAR>();
		//cookie为空直接清空cookie,同步session
		if (StringUtils.isBlank(list_cart_cookie)) {
			//cookie不为空
		} else {
			shoppingcars_cookie = MyJsonUtil.json_to_list(list_cart_cookie, T_MALL_SHOPPINGCAR.class);
			List<T_MALL_SHOPPINGCAR> shoppingcar_bd = cartServiceImp.selet_all(user.getId());
			//数据库为空 把cookie中的值添加进入数据库中
			for (int i=0;i<shoppingcars.size();i++) {
				T_MALL_SHOPPINGCAR cart = shoppingcars.get(i);
				cart.setYh_id(user.getId());
				boolean b = cartServiceImp.select_cart_exists(shoppingcars_cookie.get(i));
                //select_cart_exists方法
                //根据用户id和商品id判断购物车与cookie中的商品是否有重复
       <select id="select_cart_exists" parameterType="com.ljf.bean.T_MALL_SHOPPINGCAR"
		resultType="int">
		select count(1) from t_mall_shoppingCar where sku_id =
		#{sku_id} and yh_id = #{yh_id}
	    </select>
            //select_cart_exists方法
            //如果有重复
				if (b) {
					//则把cookie中的那条商品的数据根据id以及用户名覆盖掉数据库中的信息
					for(int a=0;a<shoppingcar_bd.size();a++){
						if (cart.getSku_id()==shoppingcar_bd.get(a).getYh_id()){
		cart.setTjshl(shoppingcars.get(i).getTjshl()+shoppingcar_bd.get(a).getTjshl());
							cart.setHj(shoppingcars.get(i).getTjshl()*cart.getSku_jg());
							cartServiceImp.update(cart);
						}
					}
				} else {
					//如果没重复就将cookie中的数据添加到数据库中
					cartServiceImp.add(shoppingcars_cookie.get(i));
				}
			}

		}
		//清空cookie
		response.addCookie(new Cookie("list_cart_cookie",""));
    //根据用户id获取购物车信息
		List<T_MALL_SHOPPINGCAR> shoppingcars1 = cartServiceImp.selet_all(user.getId());
	//同步项目的session	
    session.setAttribute("list_cart_session",shoppingcars1);
		List<T_MALL_SHOPPINGCAR>  listCartSession = (List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");

	}
```

登陆完成来到index页面

```jsp
<body>
    <jsp:include page="header.jsp"></jsp:include>
	<img src="images/top_img.jpg" width="100%">
	<jsp:include page="searchArea.jsp"></jsp:include>
	<jsp:include page="classList.jsp"></jsp:include>
	
	<div class="banner">
		<div class="ban">
			<img src="images/banner.jpg" width="980" height="380" alt="">
		</div>
	</div>
</body>
</html>
```

#### classList.jsp

```jsp
<script type="text/javascript">
    //进入页面立马给id为class_1_ul的标签添加值
	$(function (){
		$.getJSON("js/json/class_1.js",function(data){
			// 用js循环json的分类集合
			$(data).each(function(i,json){
				// 将分类集合的内容生成<option>对象加载到下拉列表中
				$("#class_1_ul").append("<li  onmouseover='get_class_2(this.value)' onmouseout='yinc()' value="+json.id+"><a href='javascript:;'>"+json.flmch1+"</a></li>");
			});
		});
	});
    //鼠标离开class_2_ul时内容清空
	function yinc() {
		$("#class_2_ul").empty();
	}
//鼠标进入class_2_ul是遍历添加值
	function get_class_2(class_1_id){

		$.getJSON("js/json/class_2_"+class_1_id+".js",function(data){-
			// 用js循环json的分类集合
			$(data).each(function(i,json){
				// 将分类集合的内容生成<option>对象加载到下拉列表中
				$("#class_2_ul").append("<li value="+json.id+"><a href='goto_list.do?flbh2="+json.id+"' target='_blank'>"+json.flmch2+"</a></li>");
			});
		});
	}
</script>

						<ul  id="class_1_ul">
							<li>
								<a href="">家用电器</a>
								<div  id="class_2_ul" class="two_nav">
								</div>
	
```

点击某个类型的商品进入到 goto_list

```java
 @RequestMapping("goto_list")
    public String goto_list(int flbh2, ModelMap map){

        // flbh2属性的集合
        List<OBJECT_T_MALL_ATTR> list_attr = attrServiceInf.get_attr_list(flbh2);

        // flbh2商品列表
        List<OBJECT_T_MALL_SKU> list_sku = new ArrayList<OBJECT_T_MALL_SKU>();
        list_sku = listServiceImp.get_list_by_flbh2(flbh2);

        map.put("list_attr", list_attr);
        map.put("list_sku", list_sku);
        map.put("flbh2", flbh2);
        return "list";
    }
```



#### list.jsp页面

```jsp
<jsp:include page="header.jsp"></jsp:include>
 <img src="images/top_img.jpg" width="100%">
<jsp:include page="searchArea.jsp"></jsp:include>
<jsp:include page="attrlist.jsp"></jsp:include>
<div id="skuListInner">
	<jsp:include page="skulist.jsp"></jsp:include>
</div>
```

##### attrlist.jsp页面(商品属性)

```jsp
<script type="text/javascript">
    var a=0;
    //传入属性id，属性值id，属性值加属性值名称
    function save_param(shxm_id,shxzh_id,shxmch) {
        var a=0;
        //获取到#paramArea内所有name为shxparams的标签并且遍历一遍
        $("#paramArea span[name = 'shxparams']").each(function (i,json) {
            //判断获取到的这条属性里面的id属性值，是否与传入进来的属性值id相同
            //如果相同则把该$("#"+shxzh_id)标签去除
            if (shxzh_id==json.id){
                a=1;
                $("#"+shxzh_id).remove();
            }
        })
        //如果遍历完#paramArea内所有name为shxparams的标签都的id都没有跟传进来的属性值id相匹配
        //那么就把传进来的参数拼接成span标签内的属性并且追加到#paramArea内
        if(a==0){
            $("#paramArea").append("<span id='"+shxm_id+"-"+shxzh_id+"' name='shxparams' onclick='removes(this)' class='layui-btn layui-btn-primary layui-btn-xs'>" +
                "<input name='shxparam' type='text' value='{\"shxm_id\":"+shxm_id+",\"shxzh_id\":"+shxzh_id+"}' style='width: 160px;text-align: center;display: none'>"+shxmch+'&#12288;'
                +"</span>");
            get_list_by_attr();
        }
        $("#"+shxm_id+"s").hide();
    }

    function get_list_by_attr(){
        //获取参数
        // var param_arry = new Array();
        <%--var jsonStr = "flbh2="+${flbh2};--%>
        var kong = 1;
        var AttrJson = {};

        $("#paramArea input[name = 'shxparam']").each(function (i,data){
            //把id为paramArea内所有name为shxparam的元素转换成json对象
           var json  = $.parseJSON(data.value);
            AttrJson["list_attr["+i+"].shxm_id"] = json.shxm_id;
            AttrJson["list_attr["+i+"].shxzh_id"] = json.shxzh_id;
            AttrJson["flbh2"] = ${flbh2};
            //上面上个赋值的意思为下三列所示，构成的是一个json字符串，里面有很多的个体
            //{list_attr[0].shxm_id = json.shxm_id
            //list_attr[0].shxzh_id = json.shxzh_id
            //flbh2 = ${flbh2}
            //}
              //{list_attr[1].shxm_id = json.shxm_id
            //list_attr[1].shxzh_id = json.shxzh_id
            //flbh2 = ${flbh2}
            //}
            // jsonStr = jsonStr +"&list_attr["+i+"].shxm_id="+json.shxm_id+"&list_attr["+i+"].shxzh_id="+json.shxzh_id;
        })

        //异步提交请求
        //刷新商品列表
        //如果选中标签内的元素为0，则刷新页面
        if ($("#paramArea input[name = 'shxparam']").length==0){
            window.location.href="goto_list.do?flbh2="+${flbh2};
        }else {
        //最后会拼接成http://localhost:8095/get_list_by_attr.do?list_attr%5B0%5D.shxm_id=1&list_attr%5B0%5D.shxzh_id=1&flbh2=17
         //由java对象接受参数
            $.get("get_list_by_attr.do",AttrJson,function (data) {
                //把数据带到
                //<div id="skuListInner">
	            //<jsp:include page="skulist.jsp"></jsp:include>
                //</div>
                $("#skuListInner").html(data);
            })
        }
    }
  
//当点击#paramArea内的元素时触发该方法
    function removes(thiss) {
        var id1 = thiss.id;
        var id_arry = id1.split("-");
        //移除掉#paramArea内某个元素//<span id="1-1" name="shxparams"</span>
        $("#"+id1).remove();
        //显示id为某某的元素 <span id="1s" style="display: none;">
        $("#"+id_arry[0]+"s").show();
        //刷新页面数据
        get_list_by_attr();
    }
</script>
<title>剑来商城</title>
</head>
<body>
    商品属性
    <div id="paramArea">

    </div>
    <hr style="margin: 0px">
      价格:&#12288;&#12288;0-4399&#12288;&#12288;4400-5699&#12288;&#12288;5700-6499&#12288;&#12288;6500-7299
       &#12288;&#12288;7300-8799&#12288;&#12288;<input type="text" style="width: 50px;" class="layui-btn layui-btn-primary layui-btn-xs"><input type="text" style="width: 50px;" class="layui-btn layui-btn-primary layui-btn-xs"><button value="确认" class="layui-btn layui-btn-primary layui-btn-xs">确认</button>
    <hr style="margin: 0px">
    <c:forEach items="${list_attr}" var="attr">
        <span id="${attr.id}s">
              ${attr.shxm_mch}:
                    <c:forEach items="${attr.list_value}" var="val">
                        &#12288;&#12288;<a href="javascript:save_param(${attr.id},${val.id},'${val.shxzh}${val.shxzh_mch}');">${val.shxzh}${val.shxzh_mch}</a>&#12288;&#12288;
                    </c:forEach>
            <hr style="margin: 0px">
        </span>
        </c:forEach>
</body>
```

```java
  @RequestMapping("/get_list_by_attr")
    public String get_list_by_attr(int flbh2,MODEL_T_MALL_SKU_ATTR_VALUE attr_value, ModelMap map){
        System.out.println(flbh2);
        List<OBJECT_T_MALL_SKU> list_sku = listServiceImp.get_list_by_attr(attr_value.getList_attr(),flbh2);
        map.put("list_sku",list_sku);
        return "skulist";
    }
```



#### 商品详情

##### jsp代码

```jsp
<C:forEach items="${list_sku}" var="sku">
	<div style="margin-top: 10px;margin-left: 10px;float: left;border: 1px #0f0f0f solid;width: 180px;height: 180px;">
		<img src="upload/image/${sku.spu.shp_tp}" style="width: 120px;height: 120px;margin-left: 30px"><br>
			<a href="goto_sku_detail.do?sku_id=${sku.id}&spu_id=${sku.spu.id}" target="_blank">${sku.sku_mch}</a> <br>
			${sku.jg}
	</div>
</C:forEach>
```

```java
@RequestMapping("goto_sku_detail")
	public String goto_sku_detail(int sku_id, int spu_id, ModelMap map,Integer cid,Integer vid){
		// 查询商品详细信息对象
		DETAIL_T_MALL_SKU obj_sku = itemServiceInf.get_sku_detail(sku_id);
		// 查询同spu下的相关的其他sku信息
		List<T_MALL_SKU> list_sku = itemServiceInf.get_sku_list_by_spu(spu_id);
		// 查询商品销售属性列表
		List<OBJECT_T_MALL_COLVER> colver = cvServiceimpl.get_colver_by_shp_id(obj_sku.getShp_id());
		// 颜色列表
		// 版本列表
		List<Integer> cvid =new  ArrayList<Integer>();
		cvid.add(cid);
		cvid.add(vid);
		map.put("cvid",cvid);
		map.put("colver",colver);
		map.put("obj_sku", obj_sku);
		map.put("list_sku", list_sku);

		return "skuDetail";
	}
```

##### 点击商品进入详情界面

```java
<div class="Dbox">
    <div class="box">
        <div class="left">
            <div class="timg"><img src="images/img_5.jpg" alt=""></div>
            <div class="timg2">
                <div class="lf"><img src="images/lf.jpg" alt=""></div>
                <div class="center">
                    <span><img src="images/icon_2.jpg" alt=""></span>
                    <span><img src="images/icon_3.jpg" alt=""></span>
                    <span><img src="images/icon_2.jpg" alt=""></span>
                    <span><img src="images/icon_3.jpg" alt=""></span>
                    <span><img src="images/icon_2.jpg" alt=""></span>
                </div>
                <div class="rg"><img src="images/rg.jpg" alt=""></div>
            </div>
            <div class="goods"><img src="images/img_6.jpg" alt=""></div>
        </div>
        <div class="cent">
            <div class="title">${obj_sku.sku_mch}</div>
            <div class="bg">
                <p>市场价：<strong>￥${obj_sku.jg}</strong></p>
                <p>促销价：<strong>￥${obj_sku.jg}</strong></p>
            </div>
            <div class="clear">
            <div class="min_t">选择款式：</div>
                //判断本页详情中的商品id是否与sku中遍历到的shu.id相同
            <c:forEach items="${list_sku}" var="sku">
                    <c:if test="${sku.id==obj_sku.id}">
                        <div class="min_mx" style="border:3px red solid">
                            <a href="goto_sku_detail.do?sku_id=${sku.id}&spu_id=${sku.shp_id}" >
                                ${sku.sku_mch}</a></div>
                    </c:if>
                <c:if test="${sku.id!=obj_sku.id}">
                    <div class="min_mx"><a href="goto_sku_detail.do?sku_id=${sku.id}&spu_id=${sku.shp_id}" >
                            ${sku.sku_mch}</a></div>
                </c:if>
            </c:forEach>
        </div>  
                <div class="clear">
            <div class="min_t">选择版本：</div>
            <c:forEach items="${colver}" var="cv">
                <c:choose>
                    //判断传进方法内的版本id与颜色id是否与遍历到的数据一致
                    <c:when test="${cvid.get(0)==cv.colorList.id && cvid.get(1)==cv.versionList.id}">    <!--如果 -->
                        <span id="${cv.colorList.id}${cv.versionList.id}">
                <div class="min_mx" style="border:3px red solid">
                    <a href="goto_sku_detail.do?sku_id=${sku.id}&spu_id=${sku.shp_id}&cid=${cv.colorList.id}&vid=${cv.versionList.id}">
                        ${cv.colorList.shp_ys}${cv.versionList.shp_bb}</a></div>
                </span>
                    </c:when>

                    <c:otherwise>  <!--否则 -->
                        <span id="${cv.colorList.id}${cv.versionList.id}">
                <div class="min_mx" >
                    <a href="goto_sku_detail.do?sku_id=${obj_sku.id}&spu_id=${obj_sku.spu.id}&cid=${cv.colorList.id}&vid=${cv.versionList.id}">
                        ${cv.colorList.shp_ys}${cv.versionList.shp_bb}</a></div>
                </span>
                    </c:otherwise>
                </c:choose>

            </c:forEach>

            <div class="clear">
                <div class="min_t" >服务：</div>
                <div class="min_mx" >售后服务</div>
                <div class="min_mx" >维修服务</div>
                <div class="min_mx" >退款换货服务</div>
                <div class="min_mx" >联系客服(可转人工)</div>
                <div class="min_mx" >满一万减1999活动火热进行中!!!</div>
            </div>
            <div class="clear" style="margin-top:20px;">
                <div class="min_t" style="line-height:36px">数量：</div>
                <div class="num_box">
                    <input type="text" name="num" value="1" style="width:40px;height:32px;text-align:center;float:left">
                    <div class="rg">
                        <img src="images/jia.jpg" id='jia' alt="">
                        <img src="images/jian.jpg" id='jian' alt="">
                    </div>
                </div>
            </div>
              //隐藏表单，把商品的详细信息存入到购物车
            <div class="clear" style="margin-top:20px;">
                <form  id="cart_form" action="add_cart.do" method="post">
                    <input type="hidden" name="sku_mch" value="${obj_sku.sku_mch}" />
                    <input type="hidden" name="sku_jg" value="${obj_sku.jg}" />
                    <input type="hidden" name="tjshl" value="1" />
                    <input type="hidden" name="hj" value="${obj_sku.jg}" />
                    <input type="hidden" name="shp_id" value="${obj_sku.shp_id}" />
                    <input type="hidden" name="sku_id" value="${obj_sku.id}" />
                    <input type="hidden" name="shp_tp" value="${obj_sku.spu.shp_tp}" />
                    <input type="hidden" name="shfxz" value="1" />
                    <input type="hidden" name="kcdz" value="${obj_sku.kcdz}" />
                //根据用户是否登陆来决定这条属性的存在
                    <c:if test="${not empty user}">
                        <input type="text" name="yh_id" value="${user.id}" />
                    </c:if>
                    <img src="images/shop.jpg" onclick="cart_submit()" alt="" style="cursor:pointer;">
                </form>

            </div>
        </div>
    </div>
</div>
<div class="Dbox1">
    <div class="boxbottom">
        <div class="top">
            <span>商品详情</span>


            <span>评价</span>
        </div>
        <div class="btm">
            商品描述:${obj_sku.spu.shp_msh}<hr>
            <c:forEach items="${obj_sku.list_image}" var="image">
                <img src="upload/image/${image.url}" height="200px"/>
            </c:forEach>
            <hr>
            <c:forEach items="${obj_sku.list_av_name}" var="av_name">
                ${av_name.shxm_mch}:${av_name.shxzh_mch}<br>
            </c:forEach>
        </div>
    </div>
</div>
```

##### 购物车后台代码

```java
 @RequestMapping("/add_cart")
    public String add_cart(HttpSession session,HttpServletResponse response, @CookieValue(value = "list_cart_cookie",required = false) String list_cart_cookie, T_MALL_SHOPPINGCAR cart, ModelMap map){
        List<T_MALL_SHOPPINGCAR> shoppingcars = new ArrayList<T_MALL_SHOPPINGCAR>();
        //添加购物车操作
        if (cart.getYh_id()==0){
            //用户未登录，操作cookie 如果list_cart_cookie为空则执行以下操作
            if (StringUtils.isBlank(list_cart_cookie)){
                //如果cookie为空，则把该条数据加入到新new出来的购物车，并用改new出来的购物车覆盖cookie的数据
                shoppingcars.add(cart);
            }else {
                //从cookie中拿数据
                shoppingcars = MyJsonUtil.json_to_list(list_cart_cookie,T_MALL_SHOPPINGCAR.class);
                //判断是否重复  传进来的商品在cookie中是否存在
                boolean b = if_new_car(cart,shoppingcars);
                if (b){
                    //不存在则，添加
                    shoppingcars.add(cart);
                }else {
                    //存在，更新
                    for(int a=0;a<shoppingcars.size();a++){
                        //根据商品skuid遍历找到skuid相同的商品并且更新数据
                        if (shoppingcars.get(a).getSku_id()==cart.getSku_id()){
                            shoppingcars.get(a).setTjshl(shoppingcars.get(a).getTjshl()+cart.getTjshl());
                            shoppingcars.get(a).setHj(shoppingcars.get(a).getTjshl()*shoppingcars.get(a).getSku_jg());
                        }
                    }
                }

            }
            //把更新完cookie中的购物车数据覆盖老cookie
            Cookie cookie = new Cookie("list_cart_cookie", MyJsonUtil.list_to_json(shoppingcars));
           System.out.println(cookie.getValue());
            //设置cookie在浏览器中存在的时间
            cookie.setMaxAge(60*60*24);
            //在浏览器响应cookie
            response.addCookie(cookie);
        }else {
            //用户已登陆
            shoppingcars = (List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");//用户刚登陆时存入session中的购物车数据
            //判断从数据库中获取的购物车是否为空
            //if (shoppingcars==null){
                //System.out.println("null");
                //再次根据用户id从数据库中获取购物车
               // shoppingcars = cartServiceImp.selet_all(cart.getYh_id());
                //直接把新添加的商品存入数据库的购物车中
               // cartServiceImp.add(cart);
           // }
           //查询数据大于或等于一条则为true
            boolean b = cartServiceImp.select_cart_exists(cart);
            //！b就是数据库中不存在跟新添加商品一样的商品
            if (!b){
                //添加数据到数据库中
                cartServiceImp.add(cart);
                //判断购物车是否为空
                if (shoppingcars==null||shoppingcars.isEmpty()){
                    shoppingcars = new ArrayList<T_MALL_SHOPPINGCAR>();
                    //如果不新new一个购物车会报空指针异常java.lang.NullPointerException
                    shoppingcars.add(cart);
                    session.setAttribute("list_cart_session",shoppingcars);
                }else {
                    //不为空只添加进购物车
                    shoppingcars.add(cart);
                }
            }else {
                 //在数据库中找到跟新添加商品一样的商品
                       for(int a=0;a<shoppingcars.size();a++){
                            //遍历数据库根据skuid找到跟新添商品一样id的商品
                           //然后用新添商品的属性值覆盖掉数据库中的商品属性
                        if (shoppingcars.get(a).getSku_id()==cart.getSku_id()){
                       shoppingcars.get(a).setTjshl(shoppingcars.get(a).getTjshl()+cart.getTjshl());
                            shoppingcars.get(a).setHj(shoppingcars.get(a).getTjshl()*shoppingcars.get(a).getSku_jg());
                            cartServiceImp.update(shoppingcars.get(a));

                        }
                    }
            }


        }

        map.put("cart",cart);
        return "redirect:/cart_success.do";
    }
```

#### 迷你购物车

在searchArea.jsp内的

```jsp
<jsp:include page="miniCart.jsp"></jsp:include>
```

miniCart.jsp内的

```java
//可以让内嵌页同时共享数据，跟在同一个页面的效果是一样的
<script>
    function show_cart() {
        $.get("miniCart.do",function (data) {
            $("#cart_list").html(data);
        })
        $("#cart_list").attr("style","display:none");
    }
    function hidden_cart() {
        $("#cart_list").attr("style","display:block");
    }
</script>
<head>
    <title>剑来商城</title>
</head>
<body>
    //鼠标进来触发show_cart函数异获取数据，鼠标离开则隐藏界面
<div class="card" onmouseout="show_cart()" onmouseover="hidden_cart()" >
    <a href="cartList.do">购物车<div class="num">0</div></a>

    <!--购物车商品-->
    <div id="cart_list" class="cart_pro"style="display: none" >
       <jsp:include page="miniCartList.jsp"></jsp:include>
    </div>
</div>
```

迷你购物车获取数据代码

```java
@RequestMapping("/miniCart")
    public String miniCart(ModelMap map,HttpSession session, @CookieValue(value = "list_cart_cookie",required = false) String list_cart_cookie){
        //从session中获取user对象
        T_MALL_USER_ACCOUNT user = (T_MALL_USER_ACCOUNT)session.getAttribute("user");
        List<T_MALL_SHOPPINGCAR> shoppingcars ;
        //如果未登录也就是user为空就从cookie中获取购物车数据
        if (user==null){
            shoppingcars = MyJsonUtil.json_to_list(list_cart_cookie, T_MALL_SHOPPINGCAR.class);
        }else {
            //用户已登陆从session中获取数据
            shoppingcars = (List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");//数据库
            //当session中的购物车为空时
            if (shoppingcars==null){
                //根据用户id在数据库中获取购物车数据
                shoppingcars = cartServiceImp.selet_all(user.getId());

            }
        }
        map.put("shoppingcars",shoppingcars);
        map.put("num",get_num(shoppingcars));
        map.put("sum",get_sum(shoppingcars));
        return "miniCartList";
    }
```

miniCartList.jsp

```jsp
<c:forEach items="${shoppingcars}" var="shop">
    <div class="one">
        <img src="upload/image/${shop.shp_tp}" width="60px;" height="60px"/>
        <span class="one_name">
                ${shop.sku_mch}
        </span>
        <span class="one_prece" >
						￥${shop.sku_jg}
						<a href="javascript:;"><button>删除</button></a>
					</span>
    </div>
</c:forEach>
<div class="gobottom">
    共<span>${num}</span>件商品&nbsp;&nbsp;&nbsp;&nbsp;
    共计￥<span>${sum}</span>
     <button class="goprice" onclick="cartList()">去购物车</button>
</div>
```

#### 购物车

```java
@RequestMapping("/cartList")
    public String cartlist(@CookieValue(value = "list_cart_cookie",required = false) String list_cart_cookie,ModelMap map,HttpSession session){
        List<T_MALL_SHOPPINGCAR> shoppingcars = null;
        T_MALL_USER_ACCOUNT user = (T_MALL_USER_ACCOUNT) session.getAttribute("user");
        if(user==null){
            shoppingcars = MyJsonUtil.json_to_list(list_cart_cookie, T_MALL_SHOPPINGCAR.class);
            System.out.println(shoppingcars.size());
        }else {
            System.out.println(user.getId());
            shoppingcars = (List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");//数据库
            if (shoppingcars==null){
                shoppingcars = cartServiceImp.selet_all(user.getId());

            }
        }
        //总价格
        map.put("sum",get_sum(shoppingcars));
        map.put("list_cart",shoppingcars);
        return "cartList";
    }
```

前端代码

cartList.jsp

```jsp
<script type="text/javascript">
	function change_shfxz(checked,skuid){
		var check = "";
		if (checked===true){
			check= "1";
		}else {
			check= "0";
		}
		$.post("change_shfxz.do",{check:check,skuid:skuid},function (data) {
			$("#cartListInner").html(data);
		})
	}

</script>	
<div id="cartListInner">
		<jsp:include page="cartListInner.jsp"></jsp:include>
	</div>

	<div class="footer">
		<div class="top"></div>
		<div class="bottom"><img src="images/foot.jpg" alt=""></div>
	</div>
```

cartListInner.jsp

```jsp

<div class="Cbox">
		<table class="table table-striped table-bordered table-hover">
		   <thead>
		     <tr>
		       <th>商品图片</th>
		       <th>商品名称</th>
		       <th>商品属性</th>
		       <th>商品价格</th>
		       <th>商品数量</th>
		       <th>操作</th>
		     </tr>
		   </thead>
		   <tbody>
		   	<c:forEach items="${list_cart}" var="cart">
			     <tr>
           //${cart.shfxz=="1"?"":""}根据商品的shfxz值是否为1决定选择框是否勾选
	 <td><input onclick="change_shfxz(this.checked,${cart.sku_id})" type="checkbox" 
                
                ${cart.shfxz=="1"?"checked":""}/><img src="upload/image/${cart.shp_tp}" alt="" width="80px"></td>
			       <td>${cart.sku_mch}</td>
			       <td>
			       		颜色：<span style='color:#ccc'>白色</span><br>
			       		尺码：<span style='color:#ccc'>L</span>
			       </td>
			       <td>${cart.sku_jg}</td>
			       <td><input type="text" name="min" value="${cart.tjshl}" style="width:50px;text-align:center"></td>
			       <td>删除</td>
			     </tr>
			</c:forEach>
		   </tbody>
	 	</table>
	</div>
	
	<div class="Cprice">
		<form id="checkOrder" action="goto_checkOrder.do">
			<div class="price">总价：${sum}</div>
			<div class="jiesuan" onclick="checkOrder()">结算</div>
		</form>

	</div>
```

页面代码功能拆分

点击该选择框去到change_shfxz函数传入本身的值(true or false)和商品skuid

```jsp
<td><input onclick="change_shfxz(this.checked,${cart.sku_id})" type="checkbox" ${cart.shfxz=="1"?"checked":""}/><img src="upload/image/${cart.shp_tp}" alt="" width="80px"></td>
```

```jsp
	function change_shfxz(checked,skuid){
		var check = "";
		if (checked===true){
			check= "1";
		}else {
			check= "0";
		}
//异步刷新内嵌页
//只是把数据带回并刷新内嵌页，其他页面不刷新
		$.post("change_shfxz.do",{check:check,skuid:skuid},function (data) {
			$("#cartListInner").html(data);
		})
	}
```

change_shfxz.do

```java
@RequestMapping("/change_shfxz")
    public String cartlists(HttpServletResponse response,String check,int skuid,HttpSession session,ModelMap map, @CookieValue(value = "list_cart_cookie",required = false) String list_cart_cookie){
        //从session中获取user
        T_MALL_USER_ACCOUNT user = (T_MALL_USER_ACCOUNT) session.getAttribute("user");
        List<T_MALL_SHOPPINGCAR> shoppingcars = null;
        //判断是否登陆
        if (user==null){
           // 如果未登陆，则从cookie中获取购物车数据
            shoppingcars = MyJsonUtil.json_to_list(list_cart_cookie, T_MALL_SHOPPINGCAR.class);
        }else {
            // 如果已经登陆，修改数据库中购物车数据
            shoppingcars = (List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");// 获取登陆时放入session中的购物车数据
        }
        //遍历购物车
        for (int a=0;a<shoppingcars.size();a++){
            //遍历判断前端购物车传过来的skuid与数据库中购物车中某条数据的skuid是否相同
            if (skuid==shoppingcars.get(a).getSku_id()){
                //把遍历到跟前端购物车传过来的skuid相同的商品的Shfxz设置为前端传过来的值
                shoppingcars.get(a).setShfxz(check);
                //再次判断用户是否登陆
                if (user==null){
                    // 把改变了某条商品Shfxz属性值的购物车覆盖cookie中的购物车
                    Cookie cookie = new Cookie("list_cart_cookie", MyJsonUtil.list_to_json(shoppingcars));
                    cookie.setMaxAge(60 * 60 * 24);
                    response.addCookie(cookie);
                }else {
                    //如果用户已经登陆
                    //把改变了Shfxz值的这条数据覆盖数据库中的同skuid的数据
                    cartServiceImp.update(shoppingcars.get(a));
                   //重新根据用户id获取数据库中的购物车然后覆盖session session.setAttribute("list_cart_session",cartServiceImp.selet_all(user.getId()));
                }

            }
        }
        //把总金额，购物车带回购物车页面
        map.put("sum",get_sum(shoppingcars));
        map.put("list_cart",shoppingcars);
        return "cartListInner";
    }
```

#### 订单

点击结算发送http://localhost:8095/goto_checkOrder.do?

来到goto_checkOrder方法

```java
@RequestMapping("/goto_checkOrder")
    public String goto_checkOrder(HttpSession session, ModelMap map){
        T_MALL_USER_ACCOUNT  user = (T_MALL_USER_ACCOUNT) session.getAttribute("user");
        if (user == null){
            //如果用户未登陆，重定向到goto_login_checkOrder
            return "redirect:/goto_login_checkOrder";
        }else {
            //session购物车列表
            List<T_MALL_SHOPPINGCAR> shoppingcars =(List<T_MALL_SHOPPINGCAR>) session.getAttribute("list_cart_session");//从用户登陆时放到session里的数据拿到购物车
            //主订单
            OBJECT_T_MALL_ORDER order = new OBJECT_T_MALL_ORDER();
            order.setYh_id(user.getId());
            order.setJdh(1);
            order.setZje(get_sum(shoppingcars));
            //根据购物车的选中状态，获得库存地址
            //
            Set<String> set_kcdz =  new HashSet<String>();
            for(int a=0;a<shoppingcars.size();a++){
                if (shoppingcars.get(a).getShfxz().equals("1")){
                    //去重
                    set_kcdz.add(shoppingcars.get(a).getKcdz());
                }
            }
            //根据库存地址封装送货清单
            List<OBJECT_T_MALL_FLOW> list_flow = new ArrayList<OBJECT_T_MALL_FLOW>();

            //迭代循环遍历
            Iterator<String> iterator = set_kcdz.iterator();
            //每一个送货地址生成一个送货清单
            while (iterator.hasNext()){
                String kcdz = iterator.next();
                //根据库存地址生成送货清单
                OBJECT_T_MALL_FLOW flow = new OBJECT_T_MALL_FLOW();
                flow.setMqdd("商品未出库");
                flow.setPsfsh("逆风快递");
                flow.setYh_id(user.getId());
                List<T_MALL_ORDER_INFO> list_info = new ArrayList<T_MALL_ORDER_INFO>();

                //循环购物车，将购物车对象转换成订单信息
                for(int a=0;a<shoppingcars.size();a++){
                    if(shoppingcars.get(a).getShfxz().equals("1")&&shoppingcars.get(a).getKcdz().equals(kcdz)){
                        T_MALL_SHOPPINGCAR cart = shoppingcars.get(a);//转换成flow
                        //将购物车转换为订单信息
                        T_MALL_ORDER_INFO info = new T_MALL_ORDER_INFO();
                        info.setSku_kcdz(cart.getKcdz());
                        info.setGwch_id(cart.getId());
                        info.setShp_tp(cart.getShp_tp());
                        info.setSku_id(cart.getSku_id());
                        info.setSku_jg(cart.getSku_jg());
                        info.setSku_mch(cart.getSku_mch());
                        info.setSku_shl(cart.getTjshl());
                        list_info.add(info);//3
                    }
                }
                flow.setOrder_info(list_info);//商品信息集合
                //将送货清单放进送货清单集合
                list_flow.add(flow);//2  物流集合
            }
            //送货清单放入主订单
            order.setList_flow(list_flow);//内存中的对象，游离态对象
           String address = addressServerInfs.get_address();
            Gson gson = new Gson();
            TypeToken<List<T_MALL_ADDRESS>> tt = new TypeToken<List<T_MALL_ADDRESS>>(){};
            ArrayList<T_MALL_ADDRESS> list_address = gson.fromJson(address,tt.getType());
            map.put("address",list_address);

            map.put("order",order);
        }
        return "checkOrder";
    }

```

请求去到验证订单页面

#### 搜索功能

```jsp

<jsp:include page="searchArea.jsp"></jsp:include>
```

```jsp
<form action="keywords.do">
					<input type="text" name="keywords" class="lf">
					<input type="submit" class="clik" value="搜索">
				</form>
```

```java
@RequestMapping("keywords")
    public String keywords(String keywords,ModelMap map) throws Exception {
        //调用keyword的关键词接口
        String  str = new String(keywords.getBytes("ISO8859_1"), "UTF-8");
        //url+关键字拼接keyword_url
        String keyword_url= MyPropertyUtil.getProperty("ws.properties","keys_url")+"?keywords="+str;
//        String  str = new String(keyword.getBytes("ISO8859_1"), "UTF-8");字符转码
        //执行keyword_url,返回数据
        String doGet = MyHttpGetUtil.doGet(keyword_url);
        List<KEYWORDFS_T_MALL_SKU> keywordfs_t_mall_skus = MyJsonUtil.json_to_list(doGet, KEYWORDFS_T_MALL_SKU.class);
        System.out.println(keywordfs_t_mall_skus);

        map.put("keywords",str);

        map.put("sku_list",keywordfs_t_mall_skus);
        return "search";
    }
```

##### keywords系统

```java
 @RequestMapping(value = "keywords")
    @ResponseBody
    public List<KEYWORDFS_T_MALL_SKU> keywords(String keywords) throws SolrServerException, UnsupportedEncodingException {
        List<KEYWORDFS_T_MALL_SKU> list_sku = new ArrayList<KEYWORDFS_T_MALL_SKU>();
        String  str = new String(keywords.getBytes("ISO8859_1"), "UTF-8");
        HttpSolrServer httpSolrServer = new HttpSolrServer(MyPropertyUtil.getProperty("solr.properties","solr_sku"));
        SolrQuery solrQuery =new SolrQuery();
        System.out.println(str);
        solrQuery.setQuery("combine_item:"+str);
        QueryResponse queryResponse = httpSolrServer.query(solrQuery);
        //设置返回数据的类型以及赋值
        list_sku= queryResponse.getBeans(KEYWORDFS_T_MALL_SKU.class);
        return list_sku;
    }
```

search.jsp搜索结果页面

```jsp
<jsp:include page="header.jsp"></jsp:include>
<img src="images/top_img.jpg" width="100%">
<jsp:include page="searchArea.jsp"></jsp:include>
<c:forEach items="${sku_list}" var="list">
	<div style="margin-top: 10px;margin-left: 10px;float: left;border: 1px #0f0f0f solid;width: 180px;height: 180px;">
		<img src="upload/image/${list.shp_tp}" alt="" style="width: 120px;height: 120px;margin-left: 30px" /><br>
		<a href="goto_sku_detail.do?sku_id=${list.id}&spu_id=${list.shp_id}" target="_blank">${list.sku_mch}</a><br>
			${list.jg}
	</div>
</c:forEach>
```

